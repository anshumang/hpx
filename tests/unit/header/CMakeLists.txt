#  Copyright (c) 2015 Agustin Berge
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

file(GLOB_RECURSE headers RELATIVE "${CMAKE_SOURCE_DIR}" "${CMAKE_SOURCE_DIR}/hpx/*.hpp")

set(sources)
set(contents "// Do not edit this file! It has been generated by the cmake configuration step.\n")
foreach(header ${headers})
  set(HPX_HEADER ${header})
  configure_file(
      "${CMAKE_SOURCE_DIR}/cmake/templates/header_test.cpp.in"
      "${CMAKE_BINARY_DIR}/tests/unit/header/${header}.cpp"
      @ONLY)

  set(sources "${sources}${CMAKE_BINARY_DIR}/tests/unit/header/${header}.cpp;")
  set(contents "${contents}#include <${header}>\n")
endforeach()

# add consistency executable
source_group("Source Files" FILES ${sources})

add_hpx_executable(consistency_test
                    SOURCES ${sources}
                    ${consistency_FLAGS}
                    EXCLUDE_FROM_ALL
                    HPX_PREFIX ${HPX_BUILD_PREFIX}
                    FOLDER "Tests/Unit/Header/")

add_hpx_unit_test("header" consistency ${consistency_PARAMETERS})

# add a custom target for this consistency
add_hpx_pseudo_target(tests.unit.header.consistency)

# make pseudo-targets depend on master pseudo-target
add_hpx_pseudo_dependencies(tests.unit.header
                            tests.unit.header.consistency)

# add dependencies to pseudo-target
add_hpx_pseudo_dependencies(tests.unit.header.consistency
                            consistency_test_exe)

# add multiple_defs executable
set(source_one "${CMAKE_BINARY_DIR}/tests/unit/header/tu1.cpp")
file(WRITE "${source_one}" "${contents}\nint main() { return 0; }")
set(source_two "${CMAKE_BINARY_DIR}/tests/unit/header/tu2.cpp")
file(WRITE "${source_two}" "${contents}")
set(sources "${source_one};${source_two}")

source_group("Source Files" FILES ${sources})

add_hpx_executable(multiple_defs_test
                    SOURCES ${sources}
                    ${multiple_defs_FLAGS}
                    EXCLUDE_FROM_ALL
                    HPX_PREFIX ${HPX_BUILD_PREFIX}
                    FOLDER "Tests/Unit/Header/")

add_hpx_unit_test("header" multiple_defs ${multiple_defs_PARAMETERS})

# add a custom target for this multiple_defs
add_hpx_pseudo_target(tests.unit.header.multiple_defs)

# make pseudo-targets depend on master pseudo-target
add_hpx_pseudo_dependencies(tests.unit.header
                            tests.unit.header.multiple_defs)

# add dependencies to pseudo-target
add_hpx_pseudo_dependencies(tests.unit.header.multiple_defs
                            multiple_defs_test_exe)
